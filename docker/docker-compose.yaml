# Docker Compose for Local Development
# =====================================
# Use this for local testing of the federated learning setup
# before deploying to Kubernetes.

version: '3.8'

services:
  # Federated Learning Server
  fl-server:
    build:
      context: ..
      dockerfile: docker/Dockerfile.server
    container_name: fl-server
    ports:
      - "8080:8080"
    volumes:
      - ../data:/app/data:ro
      - ../checkpoints:/app/checkpoints
      - ../logs:/app/logs
    environment:
      - NUM_CLIENTS=3
      - ROUNDS=10
      - DEVICE=cuda
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

  # Federated Learning Clients
  fl-client-1:
    build:
      context: ..
      dockerfile: docker/Dockerfile.client
    container_name: fl-client-1
    depends_on:
      - fl-server
    volumes:
      - ../data:/app/data:ro
    environment:
      - CLIENT_ID=1
      - SERVER_ADDRESS=fl-server:8080
      - DEVICE=cuda
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

  fl-client-2:
    build:
      context: ..
      dockerfile: docker/Dockerfile.client
    container_name: fl-client-2
    depends_on:
      - fl-server
    volumes:
      - ../data:/app/data:ro
    environment:
      - CLIENT_ID=2
      - SERVER_ADDRESS=fl-server:8080
      - DEVICE=cuda

  fl-client-3:
    build:
      context: ..
      dockerfile: docker/Dockerfile.client
    container_name: fl-client-3
    depends_on:
      - fl-server
    volumes:
      - ../data:/app/data:ro
    environment:
      - CLIENT_ID=3
      - SERVER_ADDRESS=fl-server:8080
      - DEVICE=cuda

volumes:
  data:
  checkpoints:
  logs:
